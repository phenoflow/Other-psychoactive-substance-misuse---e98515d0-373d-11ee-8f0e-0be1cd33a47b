# Kuan V, Denaxas S, Gonzalez-Izquierdo A, Direk K, Bhatti O, Husain S, Sutaria S, Hingorani M, Nitsch D, Parisinos C, Lumbers T, Mathur R, Sofat R, Casas JP, Wong I, Hemingway H, Hingorani A, 2023.

import sys, csv, re

codes = [{"code":"13cM.00","system":"readv2"},{"code":"100178.0","system":"med"},{"code":"10045.0","system":"med"},{"code":"100632.0","system":"med"},{"code":"101697.0","system":"med"},{"code":"101738.0","system":"med"},{"code":"101892.0","system":"med"},{"code":"102440.0","system":"med"},{"code":"102475.0","system":"med"},{"code":"102582.0","system":"med"},{"code":"102591.0","system":"med"},{"code":"103018.0","system":"med"},{"code":"103241.0","system":"med"},{"code":"103725.0","system":"med"},{"code":"103726.0","system":"med"},{"code":"103844.0","system":"med"},{"code":"103991.0","system":"med"},{"code":"105104.0","system":"med"},{"code":"105346.0","system":"med"},{"code":"10538.0","system":"med"},{"code":"105999.0","system":"med"},{"code":"10655.0","system":"med"},{"code":"10656.0","system":"med"},{"code":"106802.0","system":"med"},{"code":"106958.0","system":"med"},{"code":"107355.0","system":"med"},{"code":"107593.0","system":"med"},{"code":"107755.0","system":"med"},{"code":"107780.0","system":"med"},{"code":"10860.0","system":"med"},{"code":"108762.0","system":"med"},{"code":"109077.0","system":"med"},{"code":"109544.0","system":"med"},{"code":"109558.0","system":"med"},{"code":"110153.0","system":"med"},{"code":"11746.0","system":"med"},{"code":"11840.0","system":"med"},{"code":"12628.0","system":"med"},{"code":"12856.0","system":"med"},{"code":"14809.0","system":"med"},{"code":"15876.0","system":"med"},{"code":"1588.0","system":"med"},{"code":"16071.0","system":"med"},{"code":"16161.0","system":"med"},{"code":"16243.0","system":"med"},{"code":"16256.0","system":"med"},{"code":"16374.0","system":"med"},{"code":"18210.0","system":"med"},{"code":"18285.0","system":"med"},{"code":"20026.0","system":"med"},{"code":"20962.0","system":"med"},{"code":"21087.0","system":"med"},{"code":"21623.0","system":"med"},{"code":"21662.0","system":"med"},{"code":"21683.0","system":"med"},{"code":"22059.0","system":"med"},{"code":"22103.0","system":"med"},{"code":"22186.0","system":"med"},{"code":"22481.0","system":"med"},{"code":"22530.0","system":"med"},{"code":"23436.0","system":"med"},{"code":"23712.0","system":"med"},{"code":"24441.0","system":"med"},{"code":"24616.0","system":"med"},{"code":"24637.0","system":"med"},{"code":"24849.0","system":"med"},{"code":"24998.0","system":"med"},{"code":"25175.0","system":"med"},{"code":"25229.0","system":"med"},{"code":"25344.0","system":"med"},{"code":"25448.0","system":"med"},{"code":"25526.0","system":"med"},{"code":"25527.0","system":"med"},{"code":"25646.0","system":"med"},{"code":"25670.0","system":"med"},{"code":"25748.0","system":"med"},{"code":"25757.0","system":"med"},{"code":"25808.0","system":"med"},{"code":"25925.0","system":"med"},{"code":"26002.0","system":"med"},{"code":"26061.0","system":"med"},{"code":"26096.0","system":"med"},{"code":"26208.0","system":"med"},{"code":"26481.0","system":"med"},{"code":"26831.0","system":"med"},{"code":"27652.0","system":"med"},{"code":"27960.0","system":"med"},{"code":"28642.0","system":"med"},{"code":"28766.0","system":"med"},{"code":"28767.0","system":"med"},{"code":"28976.0","system":"med"},{"code":"29075.0","system":"med"},{"code":"29446.0","system":"med"},{"code":"29728.0","system":"med"},{"code":"29783.0","system":"med"},{"code":"29797.0","system":"med"},{"code":"30034.0","system":"med"},{"code":"30465.0","system":"med"},{"code":"30598.0","system":"med"},{"code":"30694.0","system":"med"},{"code":"30750.0","system":"med"},{"code":"31213.0","system":"med"},{"code":"31736.0","system":"med"},{"code":"31862.0","system":"med"},{"code":"32052.0","system":"med"},{"code":"3222.0","system":"med"},{"code":"32640.0","system":"med"},{"code":"32709.0","system":"med"},{"code":"32751.0","system":"med"},{"code":"32804.0","system":"med"},{"code":"32887.0","system":"med"},{"code":"32931.0","system":"med"},{"code":"33462.0","system":"med"},{"code":"33493.0","system":"med"},{"code":"33585.0","system":"med"},{"code":"33774.0","system":"med"},{"code":"33838.0","system":"med"},{"code":"33942.0","system":"med"},{"code":"34249.0","system":"med"},{"code":"34398.0","system":"med"},{"code":"3519.0","system":"med"},{"code":"35196.0","system":"med"},{"code":"35286.0","system":"med"},{"code":"35404.0","system":"med"},{"code":"35733.0","system":"med"},{"code":"36223.0","system":"med"},{"code":"36241.0","system":"med"},{"code":"3635.0","system":"med"},{"code":"37130.0","system":"med"},{"code":"37316.0","system":"med"},{"code":"37389.0","system":"med"},{"code":"37472.0","system":"med"},{"code":"37568.0","system":"med"},{"code":"38029.0","system":"med"},{"code":"38034.0","system":"med"},{"code":"38072.0","system":"med"},{"code":"38125.0","system":"med"},{"code":"38360.0","system":"med"},{"code":"38429.0","system":"med"},{"code":"3844.0","system":"med"},{"code":"39051.0","system":"med"},{"code":"39058.0","system":"med"},{"code":"39836.0","system":"med"},{"code":"39983.0","system":"med"},{"code":"40536.0","system":"med"},{"code":"40720.0","system":"med"},{"code":"40781.0","system":"med"},{"code":"41039.0","system":"med"},{"code":"41317.0","system":"med"},{"code":"41476.0","system":"med"},{"code":"42140.0","system":"med"},{"code":"42456.0","system":"med"},{"code":"42923.0","system":"med"},{"code":"43075.0","system":"med"},{"code":"43101.0","system":"med"},{"code":"43176.0","system":"med"},{"code":"43296.0","system":"med"},{"code":"43487.0","system":"med"},{"code":"43901.0","system":"med"},{"code":"44131.0","system":"med"},{"code":"44330.0","system":"med"},{"code":"44742.0","system":"med"},{"code":"44966.0","system":"med"},{"code":"44991.0","system":"med"},{"code":"45208.0","system":"med"},{"code":"45550.0","system":"med"},{"code":"4564.0","system":"med"},{"code":"45997.0","system":"med"},{"code":"460.0","system":"med"},{"code":"46244.0","system":"med"},{"code":"46732.0","system":"med"},{"code":"46800.0","system":"med"},{"code":"46896.0","system":"med"},{"code":"46962.0","system":"med"},{"code":"47083.0","system":"med"},{"code":"47335.0","system":"med"},{"code":"47739.0","system":"med"},{"code":"47784.0","system":"med"},{"code":"47804.0","system":"med"},{"code":"47836.0","system":"med"},{"code":"48131.0","system":"med"},{"code":"48674.0","system":"med"},{"code":"48702.0","system":"med"},{"code":"48760.0","system":"med"},{"code":"49068.0","system":"med"},{"code":"49565.0","system":"med"},{"code":"49566.0","system":"med"},{"code":"49585.0","system":"med"},{"code":"49618.0","system":"med"},{"code":"49879.0","system":"med"},{"code":"50136.0","system":"med"},{"code":"50265.0","system":"med"},{"code":"50302.0","system":"med"},{"code":"50343.0","system":"med"},{"code":"50778.0","system":"med"},{"code":"50964.0","system":"med"},{"code":"5105.0","system":"med"},{"code":"51052.0","system":"med"},{"code":"51135.0","system":"med"},{"code":"51197.0","system":"med"},{"code":"51290.0","system":"med"},{"code":"5203.0","system":"med"},{"code":"52451.0","system":"med"},{"code":"52739.0","system":"med"},{"code":"52765.0","system":"med"},{"code":"52794.0","system":"med"},{"code":"52815.0","system":"med"},{"code":"52841.0","system":"med"},{"code":"52842.0","system":"med"},{"code":"52846.0","system":"med"},{"code":"52953.0","system":"med"},{"code":"53008.0","system":"med"},{"code":"53025.0","system":"med"},{"code":"53071.0","system":"med"},{"code":"53678.0","system":"med"},{"code":"54356.0","system":"med"},{"code":"54800.0","system":"med"},{"code":"54983.0","system":"med"},{"code":"55126.0","system":"med"},{"code":"5610.0","system":"med"},{"code":"56179.0","system":"med"},{"code":"56194.0","system":"med"},{"code":"56337.0","system":"med"},{"code":"56504.0","system":"med"},{"code":"56650.0","system":"med"},{"code":"56948.0","system":"med"},{"code":"57574.0","system":"med"},{"code":"58145.0","system":"med"},{"code":"58731.0","system":"med"},{"code":"58743.0","system":"med"},{"code":"58934.0","system":"med"},{"code":"59009.0","system":"med"},{"code":"59163.0","system":"med"},{"code":"59184.0","system":"med"},{"code":"59676.0","system":"med"},{"code":"60048.0","system":"med"},{"code":"60180.0","system":"med"},{"code":"60355.0","system":"med"},{"code":"60372.0","system":"med"},{"code":"60420.0","system":"med"},{"code":"60676.0","system":"med"},{"code":"6111.0","system":"med"},{"code":"61342.0","system":"med"},{"code":"62106.0","system":"med"},{"code":"62132.0","system":"med"},{"code":"62490.0","system":"med"},{"code":"62717.0","system":"med"},{"code":"62887.0","system":"med"},{"code":"62959.0","system":"med"},{"code":"63076.0","system":"med"},{"code":"64210.0","system":"med"},{"code":"64265.0","system":"med"},{"code":"64269.0","system":"med"},{"code":"64277.0","system":"med"},{"code":"64308.0","system":"med"},{"code":"64316.0","system":"med"},{"code":"64338.0","system":"med"},{"code":"64382.0","system":"med"},{"code":"64983.0","system":"med"},{"code":"64987.0","system":"med"},{"code":"65681.0","system":"med"},{"code":"65826.0","system":"med"},{"code":"65927.0","system":"med"},{"code":"65942.0","system":"med"},{"code":"65950.0","system":"med"},{"code":"66187.0","system":"med"},{"code":"66243.0","system":"med"},{"code":"67462.0","system":"med"},{"code":"67491.0","system":"med"},{"code":"67535.0","system":"med"},{"code":"68150.0","system":"med"},{"code":"68396.0","system":"med"},{"code":"689.0","system":"med"},{"code":"69138.0","system":"med"},{"code":"69347.0","system":"med"},{"code":"69508.0","system":"med"},{"code":"69963.0","system":"med"},{"code":"69977.0","system":"med"},{"code":"70578.0","system":"med"},{"code":"70761.0","system":"med"},{"code":"70900.0","system":"med"},{"code":"70961.0","system":"med"},{"code":"71060.0","system":"med"},{"code":"71086.0","system":"med"},{"code":"72342.0","system":"med"},{"code":"72371.0","system":"med"},{"code":"72564.0","system":"med"},{"code":"72663.0","system":"med"},{"code":"72712.0","system":"med"},{"code":"73448.0","system":"med"},{"code":"73737.0","system":"med"},{"code":"73857.0","system":"med"},{"code":"7496.0","system":"med"},{"code":"7747.0","system":"med"},{"code":"8284.0","system":"med"},{"code":"8463.0","system":"med"},{"code":"85953.0","system":"med"},{"code":"86034.0","system":"med"},{"code":"86041.0","system":"med"},{"code":"8608.0","system":"med"},{"code":"87505.0","system":"med"},{"code":"90198.0","system":"med"},{"code":"9024.0","system":"med"},{"code":"91260.0","system":"med"},{"code":"91277.0","system":"med"},{"code":"91577.0","system":"med"},{"code":"91801.0","system":"med"},{"code":"91939.0","system":"med"},{"code":"92291.0","system":"med"},{"code":"92353.0","system":"med"},{"code":"9273.0","system":"med"},{"code":"93009.0","system":"med"},{"code":"93407.0","system":"med"},{"code":"93412.0","system":"med"},{"code":"93850.0","system":"med"},{"code":"93979.0","system":"med"},{"code":"93980.0","system":"med"},{"code":"94394.0","system":"med"},{"code":"94436.0","system":"med"},{"code":"94686.0","system":"med"},{"code":"95460.0","system":"med"},{"code":"95953.0","system":"med"},{"code":"95954.0","system":"med"},{"code":"95955.0","system":"med"},{"code":"95956.0","system":"med"},{"code":"96009.0","system":"med"},{"code":"96049.0","system":"med"},{"code":"96081.0","system":"med"},{"code":"9615.0","system":"med"},{"code":"96925.0","system":"med"},{"code":"97000.0","system":"med"},{"code":"97025.0","system":"med"},{"code":"97028.0","system":"med"},{"code":"97031.0","system":"med"},{"code":"97375.0","system":"med"},{"code":"97488.0","system":"med"},{"code":"97561.0","system":"med"},{"code":"97578.0","system":"med"},{"code":"97586.0","system":"med"},{"code":"97648.0","system":"med"},{"code":"97676.0","system":"med"},{"code":"97698.0","system":"med"},{"code":"97811.0","system":"med"},{"code":"98221.0","system":"med"},{"code":"98362.0","system":"med"},{"code":"98452.0","system":"med"},{"code":"98528.0","system":"med"},{"code":"98566.0","system":"med"},{"code":"98618.0","system":"med"},{"code":"98763.0","system":"med"},{"code":"98914.0","system":"med"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('other-psychoactive-substance-misuse-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["substance---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["substance---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["substance---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
